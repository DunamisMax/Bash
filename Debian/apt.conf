#!/bin/bash
# Script to configure /etc/apt/apt.conf for Debian "trixie" and "unstable"

#------------------------------------------------------------------------------
# 1) Back up existing /etc/apt/apt.conf
#------------------------------------------------------------------------------
APT_CONF_FILE="/etc/apt/apt.conf"
if [ -f "$APT_CONF_FILE" ]; then
  cp "$APT_CONF_FILE" "${APT_CONF_FILE}.bak.$(date +%Y%m%d%H%M%S)"
  echo "Backed up existing $APT_CONF_FILE to ${APT_CONF_FILE}.bak.$(date +%Y%m%d%H%M%S)"
fi

#------------------------------------------------------------------------------
# 2) Create new /etc/apt/apt.conf with recommended settings
#------------------------------------------------------------------------------
cat <<'EOF' > "$APT_CONF_FILE"
// -----------------------------------------------------------------------------
// My custom APT configuration - for Debian "trixie" + "unstable" usage
// -----------------------------------------------------------------------------

// Automatically assume "Yes" for apt-get commands, but be careful with "force-yes"!
APT::Get::Assume-Yes "true";
APT::Get::Assume-Yes "true";

// Keep downloaded packages in /var/cache/apt/archives
APT::Keep-Downloaded-Packages "true";

// Set default release to "trixie" if you have both testing and unstable in sources
// You can also handle pinning in /etc/apt/preferences.d/*.conf or apt.conf itself.
//
// NOTE: "APT::Default-Release" is read by apt-get, but not by aptitude or apt sometimes.
// Pinning in preferences is often more reliable. That said, here’s how to specify it:
APT::Default-Release "trixie";

// Don’t install Suggested packages automatically
APT::Install-Suggests "false";

// ...but do install Recommended packages automatically (typical Debian default)
APT::Install-Recommends "true";

// Enable or disable apt-listchanges or apt-listbugs (if installed):
// DPkg::Pre-Install-Pkgs { "/usr/sbin/apt-listchanges --apt || true"; };
// DPkg::Pre-Install-Pkgs { "/usr/sbin/apt-listbugs --apt || true"; };

// Limit the languages for downloaded translation files to save bandwidth
Acquire::Languages "none";

// Number of retries in case of network issues
Acquire::Retries "3";

// Always use IPv4 only (if you have IPv6 connectivity issues)
// Acquire::ForceIPv4 "true";

// Require repositories to be signed
Acquire::AllowInsecureRepositories "false";
Acquire::AllowDowngradeToInsecureRepositories "false";

// If a deb or deb-src line is missing valid-until data, this option can skip valid-until checks
// Acquire::Check-Valid-Until "false";

// Remove automatically installed dependencies when no longer needed
APT::AutoRemove::RecommendsImportant "false";
APT::AutoRemove::SuggestsImportant "false";

// You can add more advanced APT behaviors here as needed.
EOF

echo "APT configuration updated at $APT_CONF_FILE."

#------------------------------------------------------------------------------
# 3) (Optional) Create /etc/apt/preferences.d/00default-release to pin "trixie"
#    so that packages come from testing by default, unless specified otherwise.
#------------------------------------------------------------------------------
PREFERENCES_FILE="/etc/apt/preferences.d/00default-release"
cat <<'EOF' | sudo tee "$PREFERENCES_FILE" > /dev/null
Package: *
Pin: release a=trixie
Pin-Priority: 500

Package: *
Pin: release a=unstable
Pin-Priority: 200
EOF

echo "APT pinning configuration written to $PREFERENCES_FILE."

#------------------------------------------------------------------------------
# 5) Final message
#------------------------------------------------------------------------------
echo "Done. You can now run 'sudo apt update' and then 'sudo apt full-upgrade' as desired."
{
    # Global configuration
    # Use this email for Let's Encrypt notifications
    email dunamismax@tutamail.com

    # Global logging: captures startup and general events in JSON format
    log {
        output file /var/log/caddy/caddy.log
        format json
    }

    # Uncomment the following line to enable debug mode (for troubleshooting)
    # debug
}

# ------------------------------------------------------------------------------
# Redirect www to non-www
# ------------------------------------------------------------------------------
www.dunamismax.com {
    redir https://dunamismax.com{uri} permanent
}

# ------------------------------------------------------------------------------
# Main Website Configuration (FastAPI)
# ------------------------------------------------------------------------------
dunamismax.com {
    # Block access to hidden files (dotfiles) except for .well-known (needed for ACME)
    @hiddenFiles {
        path_regexp hidden ^/(?!\.well-known/)\..*
    }
    handle @hiddenFiles {
        respond 404
    }

    # Reverse proxy all other requests to the FastAPI application
    reverse_proxy localhost:8000

    # Per-site logging: write access logs in JSON format
    log {
        output file /var/log/caddy/dunamismax_access.log
        format json
    }

    # (Optional) Uncomment to enable gzip encoding for improved performance
    # encode gzip
}

# ------------------------------------------------------------------------------
# Messenger App
# ------------------------------------------------------------------------------
messenger.dunamismax.com {
    reverse_proxy localhost:8100

    log {
        output file /var/log/caddy/messenger_access.log
        format json
    }
}

# ------------------------------------------------------------------------------
# AI Agents App
# ------------------------------------------------------------------------------
agents.dunamismax.com {
    reverse_proxy localhost:8200

    log {
        output file /var/log/caddy/ai_agents_access.log
        format json
    }
}

# ------------------------------------------------------------------------------
# File Server (File Converter)
# ------------------------------------------------------------------------------
files.dunamismax.com {
    # Allow larger request bodies (up to 2GB)
    request_body {
        max_size 2GB
    }

    reverse_proxy localhost:8300 {
        transport http {
            read_timeout 3600s
            write_timeout 3600s
        }
    }

    log {
        output file /var/log/caddy/file_converter_access.log
        format json
    }
}

# ------------------------------------------------------------------------------
# Notes App
# ------------------------------------------------------------------------------
notes.dunamismax.com {
    reverse_proxy localhost:8500

    log {
        output file /var/log/caddy/notes_access.log
        format json
    }
}

# ------------------------------------------------------------------------------
# (Optional) Additional Site Configurations
# ------------------------------------------------------------------------------
# To add new sites without modifying this file, consider using the include directive:
# include /etc/caddy/sites-enabled/*.caddyfile

###############################################################################
# End of Caddyfile
###############################################################################